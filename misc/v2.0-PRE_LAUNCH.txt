PRE_LAUNCH.txt
===============
finish dev pre-launch dry run
commit translation changes
test on dev and push to vr1
dry run of pre-launch on vr1

# suspend scoutapp monitoring
# stop vr1 nginx
# stop lin1 nginx
# dump lin1 mongo.  cp to vr1
# remove critsend from SPF and DKIM
# DNS stuff - lin1 to vr1
#   remove critsend DKIM and SPF

# migrate data
cd ~/migrate_v2.0
# rm -rf *
rm ~/migrate_v2.0.txt
cd ~/rails
rails r lib/scripts/migrate_v2.0.rb  ~/mongo_dump/lin1-20141102082738.tar.gz ~/migrate_v2.0 > ~/migrate_v2.0.txt

# next two scripts handle duplicate bookmarks and users.  duplicate books are handled lazy as they are hit by users.

# bookmarks 1303 dups, 834 have same chunk
#  keep most recent based on updated_at.  delete other.
rails r lib/scripts/migrate_v2.0_dup_bookmarks.rb

# users 24 dups
#  keep most recent based on updated_at.  delete other.
rails r lib/scripts/migrate_v2.0_dup_users.rb

### END SCRIPTS ###

# create indexes.
rake db:mongoid:create_indexes

# from rails console
User.set_public_id_all
Bookmark.set_pp_all
Book.set_detail_li_all

# remove indexes
rake db:mongoid:remove_indexes

# dump db
mongodump --out ~/migrate_v2.0/v2

#HERE

# drop db
# from mongo shell
mongo
use mhd_development || use mhd_production
db.dropDatabase()

# change model index defs (the ones commented out) of user, bookmark

# import db
# mongorestore -d mhd_development ~/migrate_v2.0/v2/mhd_development
# mongorestore -d mhd_production ~/migrate_v2.0/v2/mhd_production

# create indexes.
cd ~/rails
rake db:mongoid:create_indexes

# set mongodb profiling level
mongo
use mhd_development || use mhd_production
db.setProfilingLevel(2)
quit()

# index elastic search.  
rails r lib/scripts/reindex_book_search.rb

# after dry run, change the comments in model indexes of user and bookmark back to what they were so you can do the process again.

# SERVER READY

TODO create sitemap.xml.  create_sitemap.rb

verify SSL at https://www.ssllabs.com/

mandrill
  ensure production API key
  DONE money in mandrill account
  DONE ensure mandrill DKIM and SPF
  change webhook urls to match mihudie.com, not vr1.mihudie.com

remove basic auth from Rails
  ApplicationController before_action :http_auth

nginx.conf
  change passenger_pre_start http://vr1.mihudie.com/; 
      to passenger_pre_start http://mihudie.com/; 

nginx sites-available mihudie.com
  remove server_name vr1.mihudie.com;

DONE nginx mihudie.com config location for static files needs to have expires max working.  It may be commeted out pre-production.

# rails log must be owned by group syslog or it won't rotate
rm ~/rails/log/*
touch ~/rails/log/production.log
sudo chown mhd:syslog ~/rails/log/production.log

# delete old nginx logs
# /var/log/nginx/*

# delete mongodb logs
sudo killall -SIGUSR1 mongod
sudo su -
cd /var/log/mongodb
# delete old rotated log file

nginx gzip js and css files
      gzip -1 -c mihudie.css > mihudie.css.gz
      gzip -1 -c mihudie.js > mihudie.js.gz

scoutapp
  change URL monitoring to mihudie.com and remove http auth params
  start monitoring


POST_LAUNCH
-------------
run SSL tests  testssl.com?

verify http working
curl -I http://mihudie.com

test microdata
http://www.google.com/webmasters/tools/richsnippets

submit site to baidu, google, bing, yahoo


